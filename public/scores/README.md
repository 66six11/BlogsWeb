# 魔法乐谱格式说明 (Sheet Music Format Guide)

编辑器支持两种乐谱格式：**ABC记谱法 v2.1** (推荐) 和 **旧版格式**。

---

## ABC记谱法 (ABC Notation v2.1)

遵循国际标准 [ABC Notation v2.1](https://abcnotation.com/wiki/abc:standard:v2.1)。

### 基本结构

```abc
X:1                    % 曲目编号 (必需)
T:曲目标题             % 标题
C:作曲家               % 作曲者
M:4/4                  % 拍号
L:1/8                  % 默认音符时值 (单位音符长度)
Q:1/4=120              % 速度 (每分钟120个四分音符)
K:C                    % 调号 (必需，标志头部结束)

% 音乐内容从K:之后开始
C D E F | G A B c |
```

### 音符表示

| ABC符号 | 音符 | 八度 |
|---------|------|------|
| C D E F G A B | Do Re Mi Fa Sol La Si | 第4八度 (中央C所在) |
| c d e f g a b | do re mi fa sol la si | 第5八度 (高八度) |
| C, D, E, | Do, Re, Mi, | 第3八度 (低八度) |
| c' d' e' | do' re' mi' | 第6八度 (更高) |

**注意**: 逗号(,)降低八度，撇号(')升高八度，可叠加使用。

### 升降号 (临时记号)

升降号**必须写在音符之前**：

| 符号 | 含义 |
|------|------|
| ^C | 升C (C#) |
| ^^C | 重升C (C##) |
| _B | 降B (Bb) |
| __B | 重降B (Bbb) |
| =C | 还原C (取消调号/临时升降) |

**作用范围**: 临时记号在当前小节内对同音高的音符有效，遇到小节线自动失效。

### 调号

调号影响全曲，自动应用升降号：

```abc
K:G    % G大调，F自动升半音
K:F    % F大调，B自动降半音
K:D    % D大调，F和C自动升半音
K:Am   % A小调，无升降
K:Em   % E小调，F自动升半音
```

### 时值

默认时值由 `L:` 字段指定 (如 `L:1/8` 表示八分音符)。

| 写法 | 时值说明 |
|------|----------|
| C | 默认时值 |
| C2 | 2倍默认时值 |
| C4 | 4倍默认时值 |
| C/ | 1/2默认时值 (等同于 C/2) |
| C// | 1/4默认时值 |
| C/2 | 1/2默认时值 |
| C3/2 | 1.5倍默认时值 (附点) |

### 和弦

用方括号包围同时演奏的音符：

```abc
[CEG]    % C大三和弦
[DFA]    % D小三和弦
[GBd]    % G大三和弦 (d是高八度)
[C,E,G,] % 低八度C大三和弦
[CEG]2   % 和弦持续2个单位时值
```

### 休止符

| 符号 | 含义 |
|------|------|
| z | 休止 (默认时值) |
| z2 | 2倍时长休止 |
| z/ | 1/2时长休止 |
| Z | 整小节休止 |
| x | 隐藏休止 (不显示) |

### 小节线

```abc
|    % 普通小节线 (同时重置临时记号)
|]   % 结束线
||   % 双小节线
|:   % 反复开始
:|   % 反复结束
::   % 反复开始和结束
```

### 多声部

使用 `V:` 定义不同声部，各声部独立计时：

```abc
V:1 clef=treble name="高音"
c d e f | g a b c' |

V:2 clef=bass name="低音"
C, D, E, F, | G, A, B, C |
```

也支持内联声部切换：

```abc
[V:1] c d e f | [V:2] C, D, E, F, |
```

### 速度标记

```abc
Q:1/4=120    % 每分钟120个四分音符
Q:1/2=60     % 每分钟60个二分音符
Q:120        % 简写形式
Q:"Allegro" 1/4=132   % 带速度术语
```

### 完整示例：小星星

```abc
X:1
T:Twinkle Twinkle Little Star
C:Traditional
M:4/4
L:1/4
Q:1/4=100
K:C

C C G G | A A G2 | F F E E | D D C2 |
G G F F | E E D2 | G G F F | E E D2 |
C C G G | A A G2 | F F E E | D D C2 |
```

### D大调示例 (Canon in D)

```abc
X:1
T:Canon in D
C:Pachelbel
M:4/4
L:1/8
Q:1/4=60
K:D

% 调号 K:D 表示 F# 和 C# 自动应用
V:1 name="Bass"
D,4 A,4 | B,4 F,4 |

V:2 name="Melody"
f2 e2 | d2 c2 |
```

---

## 旧版格式 (Legacy Format)

兼容之前版本的简化格式。

### 基本格式

每行一个音符或和弦：
```
音符名 八度 时值
```

### 元数据

```
#@ title: 曲目名称
#@ bpm: 120
#@ key: C Major
#@ time: 4/4
```

### 音符参数

**音符名**: C, C#, D, D#, E, F, F#, G, G#, A, A#, B (支持 Db, Eb 等等音)

**八度**: 3, 4, 5

**时值** (十六分音符为单位): 1=十六分, 2=八分, 4=四分, 8=二分, 16=全

### 和弦

用 `+` 连接同时演奏的音符：
```
C 4 + E 4 + G 4 4
```

### 多轨道

```
[Bass]
C 3 4

[Melody:0]
E 5 4
```

---

## 文件存放

将乐谱文件放入 `/public/scores/` 目录，在 `config.ts` 中添加：

```typescript
scores: {
  folder: "/scores",
  files: ['my-song.abc', 'other-song.txt']
}
```

**推荐使用 `.abc` 扩展名** 表示ABC记谱法文件。
