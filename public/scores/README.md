# 魔法乐谱格式说明 (Sheet Music Format Guide)

## 基本格式

每行一个音符或和弦，格式为：
```
音符名 八度 时值
```

用空格或制表符分隔。

## 元数据 (Metadata)

在乐谱开头使用特殊注释指定元数据：

```
#@ title: 曲目名称
#@ bpm: 120
#@ key: C Major
#@ time: 4/4
```

支持的元数据：
- `title` - 曲目标题
- `bpm` / `tempo` - 速度 (每分钟拍数)
- `key` - 调号
- `time` / `timesignature` - 拍号

## 多轨道支持 (Multi-Track)

使用 `[TrackName]` 切换轨道，每个轨道独立计时：

```
# 低音声部
[Bass]
C 3 4
G 3 4

# 主旋律 - 从第0拍开始（与低音同时）
[Melody:0]
E 5 4
D 5 4

# 和弦声部 - 也从第0拍开始
[Chords:0]
C 4 + E 4 + G 4 4
```

### 轨道命令
- `[TrackName]` - 切换到指定轨道，继续当前位置
- `[TrackName:0]` - 切换到指定轨道并重置到第0拍
- `@16` - 将当前轨道跳转到第16拍位置

## 参数说明

### 1. 音符名 (Note Name)
支持12个半音，不区分大小写：
| 音符 | 说明 | 等音 |
|------|------|------|
| C | Do | |
| C# | Do升半音 | Db |
| D | Re | |
| D# | Re升半音 | Eb |
| E | Mi | |
| F | Fa | |
| F# | Fa升半音 | Gb |
| G | Sol | |
| G# | Sol升半音 | Ab |
| A | La | |
| A# | La升半音 | Bb |
| B | Si | |

### 2. 八度 (Octave)
数字表示八度，编辑器支持第3、4、5八度：
- `3` = 低八度
- `4` = 中央C所在八度 (C4是中央C)
- `5` = 高八度

### 3. 时值 (Duration)
以十六分音符为单位：
| 时值 | 音符类型 |
|------|----------|
| 1 | 十六分音符 |
| 2 | 八分音符 |
| 4 | 四分音符 |
| 8 | 二分音符 |
| 16 | 全音符 |

## 和弦 (Chords)

使用 `+` 符号连接同时播放的音符，时值写在最后：

```
音符1 八度 + 音符2 八度 + 音符3 八度 时值
```

### 和弦示例
```
# C大三和弦 (C-E-G)
C 4 + E 4 + G 4 4

# Am和弦 (A-C-E)  
A 4 + C 5 + E 5 4

# G7和弦
G 4 + B 4 + D 5 + F 5 4
```

## 注释

以 `#` 开头的行为注释，会被忽略（除了 `#@` 元数据）。
空行也会被忽略。

```
# 这是注释
#@ bpm: 120  <- 这是元数据
```

## 完整示例：卡农

```
#@ title: Canon in D
#@ bpm: 60
#@ key: D Major

# 低音声部
[Bass]
D 3 8
A 3 8
B 3 8
F# 3 8

# 和弦声部 - 从头开始
[Chords:0]
D 4 + F# 4 + A 4 8
A 3 + C# 4 + E 4 8
B 3 + D 4 + F# 4 8
F# 3 + A 3 + C# 4 8

# 主旋律 - 从头开始
[Melody:0]
F# 5 4
E 5 4
D 5 4
C# 5 4
B 4 4
A 4 4
B 4 4
C# 5 4
```

## 文件存放

将乐谱文件（.txt格式）放入 `/public/scores/` 目录，然后在 `config.ts` 的 `MEDIA_CONFIG.scores.files` 数组中添加文件名：

```typescript
scores: {
  folder: "/scores",
  files: ['sample.txt', 'canon-in-d.txt']
}
```

## 速率控制

- 乐谱可通过 `#@ bpm: 120` 指定默认速率
- 播放时可通过界面上的 BPM 控制器实时调整
- 支持范围：40-240 BPM

## 注意事项

1. 单音符在当前轨道顺序播放
2. 和弦中的所有音符同时播放，共享同一个时值
3. 不同轨道可以同时播放（使用 `[TrackName:0]` 重置位置）
4. 编辑器网格会根据音符自动延长
5. 播放会在最后一个音符结束后自动停止
